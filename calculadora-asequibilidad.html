<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Asequibilidad - Prestamigo</title>
    <style>
        /* [Previous CSS styles remain exactly the same] */
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="calculator-container">
        <!-- [Previous HTML structure remains exactly the same until the script section] -->
    </div>

    <script>
        // Current date in YYYY-MM-DD format for fallback
        const currentDate = new Date().toISOString().split('T')[0];
        
        // Default rates (fallback if JSON fails to load)
        const defaultRates = {
            last_updated: currentDate,
            rates: {
                FHA: 6.25,
                CONV: 5.75,
                ITIN: 7.25
            }
        };
        
        // Credit score adjustments
        const creditAdjust = {
            720: 0.0,
            680: 0.5,
            620: 1.0,
            580: 1.5
        };
        
        // Format date to Spanish format (DD/MM/YYYY)
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        // Main calculation function
        async function calculate() {
            // Show loading state
            const calculateBtn = document.querySelector('.calculate-btn');
            calculateBtn.textContent = 'Calculando...';
            calculateBtn.disabled = true;
            
            try {
                // Load rates data
                let ratesData;
                try {
                    const response = await fetch('rates.json?v=' + new Date().getTime()); // Cache busting
                    ratesData = response.ok ? await response.json() : defaultRates;
                    
                    // Validate loaded data
                    if (!ratesData.rates || !ratesData.rates.FHA || !ratesData.rates.CONV || !ratesData.rates.ITIN) {
                        ratesData = defaultRates;
                    }
                } catch (e) {
                    console.error("Error loading rates:", e);
                    ratesData = defaultRates;
                }
                
                // Get user inputs
                const income = parseFloat(document.getElementById("income").value) || 0;
                const debt = parseFloat(document.getElementById("debt").value) || 0;
                const loanType = document.getElementById("loanType").value;
                const creditScore = parseInt(document.getElementById("credit").value);
                
                // Calculate adjusted rate based on loan type and credit score
                const baseRates = {
                    FHA: ratesData.rates.FHA,
                    CONV: ratesData.rates.CONV,
                    ITIN: ratesData.rates.ITIN
                };
                
                const rateAdjustments = {
                    FHA: 0.5,
                    CONV: 0.25,
                    ITIN: 1.0
                };
                
                const baseRate = baseRates[loanType];
                const adjustment = rateAdjustments[loanType] * (creditAdjust[creditScore] || 1.5);
                const finalRate = baseRate + adjustment;
                
                // Calculate affordability (using standard 36% debt-to-income ratio)
                const maxDTIPayment = (income * 0.36) - debt;
                const loanTermMonths = 360; // 30 years
                const monthlyInterestRate = finalRate / 100 / 12;
                
                // Calculate maximum loan amount based on payment
                const maxLoanAmount = maxDTIPayment * (
                    (Math.pow(1 + monthlyInterestRate, loanTermMonths) - 1) /
                    (monthlyInterestRate * Math.pow(1 + monthlyInterestRate, loanTermMonths))
                );
                
                // Calculate home price range based on down payment options
                const fhaDownPaymentPercent = 0.035; // 3.5%
                const convDownPaymentPercent = 0.20; // 20%
                
                const fhaHomePrice = maxLoanAmount / (1 - fhaDownPaymentPercent);
                const convHomePrice = maxLoanAmount / (1 - convDownPaymentPercent);
                
                // Determine which programs are available
                const programs = [];
                if (loanType === 'FHA') programs.push('FHA');
                if (loanType === 'CONV') programs.push('Convencional');
                if (loanType === 'ITIN') programs.push('ITIN');
                
                if (creditScore >= 680) programs.push('First-Time Buyer');
                if (income <= (income * 0.80)) programs.push('Low Income Assistance');
                
                // Display results
                document.getElementById("interestRate").textContent = finalRate.toFixed(2) + "%";
                document.getElementById("monthlyPayment").textContent = "$" + Math.round(maxDTIPayment).toLocaleString('es');
                document.getElementById("homePrice").textContent = "$" + 
                    Math.round(Math.min(fhaHomePrice, convHomePrice)).toLocaleString('es') + " - $" + 
                    Math.round(Math.max(fhaHomePrice, convHomePrice)).toLocaleString('es');
                document.getElementById("downPayment").textContent = "$" + 
                    Math.round(fhaHomePrice * fhaDownPaymentPercent).toLocaleString('es') + " - $" + 
                    Math.round(convHomePrice * convDownPaymentPercent).toLocaleString('es');
                
                // Update programs
                const programsContainer = document.getElementById("programTags");
                programsContainer.innerHTML = programs.map(p => 
                    `<span class="program-tag">${p}</span>`
                ).join('');
                
                // Update rate source date
                document.getElementById("rate-source").textContent = 
                    `Tasas actualizadas el ${formatDate(ratesData.last_updated)}`;
                
                // Show results panel
                document.getElementById("results").style.display = 'block';
                
            } catch (error) {
                console.error("Calculation error:", error);
                alert("Ocurri√≥ un error al calcular. Por favor intente nuevamente.");
            } finally {
                // Reset button state
                calculateBtn.textContent = 'Calcular Asequibilidad';
                calculateBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
